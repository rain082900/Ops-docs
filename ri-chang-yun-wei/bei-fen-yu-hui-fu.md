### 备份与恢复

系统运行一段时间以后，为了避免发生不可逆转的意外，如机器故障，主节点磁盘损坏，etcd数据目录被误删除等，需要经常备份重要数据，方便故障解除后迅速恢复生产环境。

#### 数据备份

##### 需要备份清单

1.etcd存储数据。etcd保存了整个kubernetes集群的状态，包括所有应用的运行状态，所有节点的资源使用情况，应用的部署信息，集群事件等。

2.nfs持久化的数据。nfs服务器保存了所有存储器挂载的数据，包括集群内部数据库，应用的配置文件等。

3.镜像仓库数据目录。镜像仓库包含了上传到镜像仓库的所有镜像，以及它们的基本信息，如上传时间，创建者，所在项目等。

4.其他数据备份。

##### etcd备份

1. 登录kubernetes集群主节点所在机器
2. 备份/var/lib/etcd/data 目录下的所有文件

##### nfs备份

1. 登录nfs服务端所在机器
2. 备份nfs根目录下所有文件

> nfs根目录路径可以查看nfs的配置文件， vi /etc/exports

##### 镜像仓库备份

1. 登录镜像仓库服务器
2. 备份镜像仓库根目录下所有文件

> 镜像仓库根目录路径可以查看harbor的配置文件，vi docker-compose.yml 默认为/data目录

##### 服务网关、动态路由备份

1. 登录应用部署平台,找到API网关,选择管理应用

![](/assets/45.png)2.找到对应的postgreSQL对应的数据端口

![](/assets/46.png) 3.  使用navicat工具连接数据库,备份数据.用户名密码都是kong

![](/assets/47.png)![](/assets/48.jpg)![](/assets/49.png)![](/assets/50.png)

其他数据备份

没有部署在kubernetes集群的其他存储服务，如外部数据库等。

#### 数据恢复

当发生了不可逆转的意外情况以后需要恢复现场 ，注意，还原现场的程度取决于备份的频率，也就是说只能还原到最近一次备份的部分。

##### 恢复kubernetes集群

1. 把etcd的备份放在对应位置
2. 重启主节点所在服务器

##### 恢复nfs数据

1. 拷贝nfs备份数据到对应目录
2. 重启nfs服务 `systemctl restart nfs`

##### 恢复镜像仓库

1. 拷贝镜像仓库备份到相应位置
2. 重启镜像仓库 

```
#进入镜像仓库安装目录
#先关闭再启动
docker-compose down
docker-compose up -d
```

##### 恢复服务网关、动态路由备份

##### 

##### 定期清理应用日志

应用输出日志将保留数天，在生产环境中请把日志输出级别调整到“error”。

对于不能自动清理日志的服务，可以选择把日志目录挂载出来，定期手动清理，防止日志文件太大撑爆磁盘。

